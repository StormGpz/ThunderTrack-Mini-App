<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThunderTrack Quick Auth</title>
    
    <!-- æ€§èƒ½ä¼˜åŒ–: é¢„è¿æ¥Quick AuthæœåŠ¡å™¨ -->
    <link rel="preconnect" href="https://auth.farcaster.xyz" />
    
    <!-- Farcaster Mini App Embed -->
    <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://thundertrack-miniapp.vercel.app/icons/Icon-512.png","button":{"title":"âš¡ å¿«é€Ÿè®¤è¯","action":{"type":"launch_miniapp","name":"ThunderTrack Quick Auth","url":"https://thundertrack-miniapp.vercel.app/quick_auth_test.html","splashImageUrl":"https://thundertrack-miniapp.vercel.app/icons/Icon-512.png","splashBackgroundColor":"#6366f1"}}}' />
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }
        .container {
            text-align: center;
            max-width: 400px;
            margin: 50px auto;
        }
        .logo { font-size: 60px; margin-bottom: 20px; }
        .title { font-size: 32px; font-weight: bold; margin-bottom: 10px; }
        .subtitle { font-size: 16px; opacity: 0.9; margin-bottom: 30px; }
        .card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        .status { font-weight: bold; font-size: 16px; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
        .user-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            text-align: left;
        }
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            margin-right: 12px;
        }
        .logs {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            text-align: left;
            font-family: 'Monaco', 'Menlo', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">âš¡</div>
        <div class="title">ThunderTrack</div>
        <div class="subtitle">Quick Auth é›†æˆæµ‹è¯•</div>
        
        <div class="card">
            <div style="font-size: 20px; font-weight: bold; margin-bottom: 15px;">ğŸ” è®¤è¯çŠ¶æ€</div>
            <div>SDKçŠ¶æ€: <span class="status" id="sdk-status">åˆå§‹åŒ–ä¸­...</span></div>
            <div>è®¤è¯çŠ¶æ€: <span class="status" id="auth-status">æœªå¼€å§‹</span></div>
            <div>ReadyçŠ¶æ€: <span class="status" id="ready-status">ç­‰å¾…ä¸­</span></div>
            
            <div id="user-container" style="display: none;">
                <div class="user-info" id="user-info">
                    <!-- ç”¨æˆ·ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
        
        <div class="card">
            <strong>ğŸ” è°ƒè¯•æ—¥å¿—:</strong>
            <div class="logs" id="logs"></div>
        </div>
    </div>

    <!-- ä½¿ç”¨ESMæ–¹å¼åŠ è½½SDK -->
    <script type="module">
        import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
        
        let logs = [];
        let authComplete = false;
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const icons = {
                success: 'âœ…',
                error: 'âŒ', 
                warning: 'âš ï¸',
                info: 'ğŸ“'
            };
            const logMessage = `${icons[type]} [${timestamp}] ${message}`;
            
            logs.push(logMessage);
            const logElement = document.getElementById('logs');
            logElement.innerHTML = logs.slice(-20).join('<br>');
            logElement.scrollTop = logElement.scrollHeight;
            console.log(logMessage);
        }
        
        function updateStatus(elementId, text, type = 'info') {
            const element = document.getElementById(elementId);
            const classes = {
                success: 'success',
                error: 'error', 
                warning: 'warning',
                info: 'info'
            };
            element.innerHTML = `<span class="${classes[type]}">${text}</span>`;
        }
        
        function displayUserInfo(context) {
            const userContainer = document.getElementById('user-container');
            const userInfo = document.getElementById('user-info');
            
            try {
                if (context && context.user) {
                    addLog('ğŸ” å¤„ç†ç”¨æˆ·ä¿¡æ¯...', 'info');
                    
                    // å®‰å…¨åœ°æå–ç”¨æˆ·ä¿¡æ¯ï¼Œé¿å…Symbol.toPrimitiveé—®é¢˜
                    const user = {};
                    try {
                        user.fid = context.user.fid ? String(context.user.fid) : 'unknown';
                        user.username = context.user.username ? String(context.user.username) : '';
                        user.displayName = context.user.displayName ? String(context.user.displayName) : '';
                        // è°¨æ…å¤„ç†pfpUrl
                        user.pfpUrl = '';
                        if (context.user.pfpUrl) {
                            try {
                                user.pfpUrl = String(context.user.pfpUrl);
                            } catch (e) {
                                addLog('âš ï¸ æ— æ³•è·å–ç”¨æˆ·å¤´åƒURL', 'warning');
                            }
                        }
                    } catch (e) {
                        addLog(`âš ï¸ æå–ç”¨æˆ·ä¿¡æ¯æ—¶å‡ºé”™: ${e.message}`, 'warning');
                    }
                    
                    // å®‰å…¨åœ°æå–å®¢æˆ·ç«¯ä¿¡æ¯
                    const client = {};
                    try {
                        client.platformType = context.client?.platformType ? String(context.client.platformType) : 'unknown';
                        client.clientFid = context.client?.clientFid ? String(context.client.clientFid) : 'unknown';
                        client.added = context.client?.added ? 'æ˜¯' : 'å¦';
                    } catch (e) {
                        addLog(`âš ï¸ æå–å®¢æˆ·ç«¯ä¿¡æ¯æ—¶å‡ºé”™: ${e.message}`, 'warning');
                    }
                    
                    // å®‰å…¨åœ°æå–ä½ç½®ä¿¡æ¯
                    let locationType = '';
                    try {
                        locationType = context.location?.type ? String(context.location.type) : '';
                    } catch (e) {
                        addLog(`âš ï¸ æå–ä½ç½®ä¿¡æ¯æ—¶å‡ºé”™: ${e.message}`, 'warning');
                    }
                    
                    userInfo.innerHTML = `
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            ${user.pfpUrl ? `<img src="${user.pfpUrl}" class="avatar" onerror="this.style.display='none'" />` : 'ğŸ‘¤'}
                            <div>
                                <div style="font-weight: bold;">${user.displayName || user.username || 'Unknown User'}</div>
                                <div style="opacity: 0.8; font-size: 14px;">FID: ${user.fid}</div>
                            </div>
                        </div>
                        <div style="font-size: 14px;">
                            <div>å¹³å°: ${client.platformType}</div>
                            <div>å®¢æˆ·ç«¯: ${client.clientFid}</div>
                            <div>å·²æ·»åŠ : ${client.added}</div>
                            ${locationType ? `<div>å¯åŠ¨æ¥æº: ${locationType}</div>` : ''}
                        </div>
                    `;
                    userContainer.style.display = 'block';
                    addLog('âœ… ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºå®Œæˆ', 'success');
                }
            } catch (error) {
                addLog(`âŒ æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
                // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
                userInfo.innerHTML = `<div style="color: #f59e0b;">âš ï¸ ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºå¼‚å¸¸</div>`;
                userContainer.style.display = 'block';
            }
        }
        
        async function initializeApp() {
            try {
                addLog('ğŸš€ å¼€å§‹åˆå§‹åŒ–ThunderTrackåº”ç”¨');
                updateStatus('sdk-status', 'æ£€æµ‹SDK...', 'warning');
                
                // æ£€æŸ¥SDKæ˜¯å¦å¯ç”¨
                if (!sdk) {
                    throw new Error('SDKæœªåŠ è½½');
                }
                
                addLog('âœ… SDKåŠ è½½æˆåŠŸ', 'success');
                updateStatus('sdk-status', 'âœ… å·²åŠ è½½', 'success');
                
                // è·å–contextä¿¡æ¯
                if (sdk.context) {
                    addLog('ğŸ“‹ è·å–åˆ°contextä¿¡æ¯', 'success');
                    displayUserInfo(sdk.context);
                } else {
                    addLog('âš ï¸ æœªè·å–åˆ°contextä¿¡æ¯', 'warning');
                }
                
                // å¼€å§‹Quick Authæµç¨‹
                updateStatus('auth-status', 'æ­£åœ¨è®¤è¯...', 'warning');
                addLog('ğŸ” å¼€å§‹Quick Authè®¤è¯æµç¨‹');
                
                try {
                    // æ–¹æ³•1: å°è¯•è·å–token
                    addLog('ğŸ“ å°è¯•è·å–Quick Auth token...');
                    const { token } = await sdk.quickAuth.getToken();
                    
                    if (token) {
                        addLog('ğŸ‰ æˆåŠŸè·å–è®¤è¯token', 'success');
                        updateStatus('auth-status', 'âœ… è®¤è¯æˆåŠŸ', 'success');
                        
                        // è§£ætoken payload (ä»…ç”¨äºå±•ç¤ºï¼Œç”Ÿäº§ç¯å¢ƒåº”åœ¨æœåŠ¡å™¨éªŒè¯)
                        try {
                            const payload = JSON.parse(atob(token.split('.')[1]));
                            addLog(`ğŸ‘¤ ç”¨æˆ·FID: ${payload.sub}`, 'info');
                            addLog(`ğŸ  åŸŸå: ${payload.aud}`, 'info');
                        } catch (e) {
                            addLog('âš ï¸ æ— æ³•è§£ætoken payload', 'warning');
                        }
                        
                        // è®¤è¯æˆåŠŸï¼Œè°ƒç”¨ready
                        await callReady();
                        
                    } else {
                        addLog('âŒ æœªè·å–åˆ°token', 'error');
                        updateStatus('auth-status', 'âŒ è®¤è¯å¤±è´¥', 'error');
                    }
                    
                } catch (authError) {
                    addLog(`âŒ Quick Authå¤±è´¥: ${authError.message}`, 'error');
                    updateStatus('auth-status', 'âŒ è®¤è¯é”™è¯¯', 'error');
                    
                    // è®¤è¯å¤±è´¥ä¹Ÿå°è¯•è°ƒç”¨ready
                    addLog('ğŸ”„ è®¤è¯å¤±è´¥ï¼Œå°è¯•ç›´æ¥è°ƒç”¨ready...', 'warning');
                    await callReady();
                }
                
            } catch (error) {
                addLog(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                updateStatus('sdk-status', 'âŒ åŠ è½½å¤±è´¥', 'error');
                updateStatus('auth-status', 'âŒ æœªå¼€å§‹', 'error');
            }
        }
        
        async function callReady() {
            try {
                addLog('ğŸš€ å‡†å¤‡è°ƒç”¨sdk.actions.ready()...');
                updateStatus('ready-status', 'æ­£åœ¨è°ƒç”¨...', 'warning');
                
                if (sdk.actions && typeof sdk.actions.ready === 'function') {
                    await sdk.actions.ready();
                    addLog('ğŸ‰ ready()è°ƒç”¨æˆåŠŸï¼Œå¯åŠ¨å±åº”è¯¥å·²éšè—', 'success');
                    updateStatus('ready-status', 'âœ… å·²è°ƒç”¨', 'success');
                    authComplete = true;
                    return true;
                } else {
                    addLog('âŒ readyæ–¹æ³•ä¸å­˜åœ¨', 'error');
                    updateStatus('ready-status', 'âŒ æ–¹æ³•ä¸å­˜åœ¨', 'error');
                    return false;
                }
            } catch (error) {
                addLog(`âŒ ready()è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                updateStatus('ready-status', 'âŒ è°ƒç”¨å¤±è´¥', 'error');
                return false;
            }
        }
        
        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            addLog(`ğŸ’¥ å…¨å±€é”™è¯¯: ${event.error?.message || event.message}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            addLog(`ğŸ’¥ æœªå¤„ç†çš„Promiseé”™è¯¯: ${event.reason?.message || event.reason}`, 'error');
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            addLog('ğŸ“„ DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            initializeApp();
        });
        
        // å¦‚æœDOMå·²ç»åŠ è½½å®Œæˆï¼Œç«‹å³æ‰§è¡Œ
        if (document.readyState === 'loading') {
            addLog('â³ ç­‰å¾…DOMåŠ è½½å®Œæˆ...');
        } else {
            addLog('ğŸ“„ DOMå·²å°±ç»ªï¼Œç«‹å³å¼€å§‹åˆå§‹åŒ–...');
            initializeApp();
        }
        
        // æš´éœ²ç»™å…¨å±€ä»¥ä¾¿è°ƒè¯•
        window.debugSDK = {
            sdk,
            logs,
            callReady,
            initializeApp
        };
        
    </script>
</body>
</html>